services:
  base:
    image: fishbot_base:latest
    build:
      context: .
      dockerfile: docker/Dockerfile
    command: ["true"]

  gazebo:
    container_name: fishbot_gazebo
    build:
      context: .
      dockerfile: docker/Dockerfile.gazebo
      args:
        BASE_IMAGE: fishbot_base:latest
    depends_on:
      - base
    ipc: host
    tty: true
    runtime: nvidia
    privileged: true
    network_mode: host
    env_file: ./docker/ros.env
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - QT_X11_NO_MITSHM=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/root/.Xauthority:ro
      - ./src/gazebo_sim/:/fishbot_ws/src/gazebo_sim/
    command: >
      bash -lc "ros2 launch gazebo_sim quick.launch.py world:=fishbot2.world pattern:=grid x:=-3 count:=4"

  navigation:
    container_name: fishbot_navigation
    build:
      context: .
      dockerfile: docker/Dockerfile.navigation
      args:
        BASE_IMAGE: fishbot_base:latest
    depends_on:
      - base
    network_mode: host
    ipc: host
    tty: true
    env_file: ./docker/ros.env
    environment:
      - FISHBOT_NAV_ROBOTS=${FISHBOT_NAV_ROBOTS:-bot1}
    volumes:
      - ./src/navigation/:/fishbot_ws/src/navigation/
    command: >
      bash -lc "ros2 launch fishbot_navigation navigation.launch.py robots:=${FISHBOT_NAV_ROBOTS:-bot1}"

  foxglove:
    container_name: fishbot_foxglove
    build:
      context: .
      dockerfile: docker/Dockerfile.foxglove
      args:
        BASE_IMAGE: fishbot_base:latest
    depends_on:
      - base
    network_mode: host
    ipc: host
    tty: true
    env_file: ./docker/ros.env
    environment:
      - FOXGLOVE_PORT=${FOXGLOVE_PORT:-8765}
      - FOXGLOVE_ADDRESS=${FOXGLOVE_ADDRESS:-0.0.0.0}
      - FOXGLOVE_ACTIVE_ROBOT=${FOXGLOVE_ACTIVE_ROBOT:-bot1}
      - FOXGLOVE_GOAL_TOPIC=${FOXGLOVE_GOAL_TOPIC:-move_base/goal}
      - FOXGLOVE_UI_GOAL_TOPIC=${FOXGLOVE_UI_GOAL_TOPIC:-/ui/goal_pose}
      - FOXGLOVE_LAYOUT=${FOXGLOVE_LAYOUT:-/fishbot_ws/install/share/fishbot_foxglove/layouts/multi_robot_navigation.json}
    volumes:
      - ./src/foxglove_app/:/fishbot_ws/src/foxglove_app/
    command: >
      bash -lc "ros2 launch fishbot_foxglove foxglove.launch.py port:=${FOXGLOVE_PORT:-8765} address:=${FOXGLOVE_ADDRESS:-0.0.0.0} active_robot:=${FOXGLOVE_ACTIVE_ROBOT:-bot1} goal_topic:=${FOXGLOVE_GOAL_TOPIC:-move_base/goal} ui_goal_topic:=${FOXGLOVE_UI_GOAL_TOPIC:-/ui/goal_pose} layout:=${FOXGLOVE_LAYOUT:-/fishbot_ws/install/share/fishbot_foxglove/layouts/multi_robot_navigation.json}"
